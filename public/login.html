<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plant Advisor | Login</title>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* --- CSS yang sudah ada di halaman Login --- */
.error-msg {
    color: #dc3545; /* Merah */
    font-size: 14px;
    margin: 4px 0 10px 0;
    padding: 0;
    min-height: 15px; /* Menjaga layout stabil */
}

/* Tambahan: Error untuk pesan di dalam card, misal Email Not Verified */
.login-error-general {
    color: #721c24; 
    background: #f8d7da; /* Background merah muda */
    border: 1px solid #f5c6cb;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    display: none; /* Default tersembunyi */
}

.forgot-pass {
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
}

.forgot-pass a {
    color: white; 
    text-decoration: none;
    font-weight: 500;
}

.forgot-pass a:hover {
    text-decoration: underline;
}

/* --- CSS POPUP SUKSES/ERROR (Fixed Position) --- */
.popup-fixed{
    position:fixed;
    top:20px;
    right:20px;
    width:250px; 
    height:auto;
    z-index:9999;
    border-radius:8px; 
    padding:10px 15px; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
    font-family: 'Inter', sans-serif;
    text-align: left; 
    opacity: 0;
    transform: translateX(120%);
    display: none; 
}

.popup-success{
    background: #f0fff0; 
    border: 1px solid #28a745; 
    color:#333; 
}
.popup-success h3{
    color:#28a745; 
}

.popup-error{
    background: #fff0f0; 
    border: 1px solid #dc3545; 
    color:#333; 
}
.popup-error h3{
    color:#dc3545; 
}

.popup-fixed h3{
    margin-top:0;
    margin-bottom:2px;
    font-size:14px; 
    font-weight: 600; 
}

.popup-fixed p{
    margin:0;
    font-size:12px; 
    color:#555; 
}

/* Styling untuk indikasi validasi */
.input-invalid {
    border: 2px solid #dc3545 !important;
}
.input-valid {
    border: 2px solid #28a745 !important;
}

/* Notifikasi URL Status Verifikasi */
.notification-banner {
    padding: 10px;
    margin-bottom: 20px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 600;
    display: none; /* Default tersembunyi */
    /* Warna akan diset oleh JS */
}

</style>
</head>

<body>
<div class="login-page">
    <div class="login-card">

        <div class="header-center">
            <h1 class="brand">Plant <span>Advisor</span></h1>
            <p class="register-text">
                Don't Have an Account? <a href="register.html">Register</a>
            </p>
        </div>
        
        <div id="statusNotification" class="notification-banner"></div>
        <h1 class="login-title">Login</h1>
        
        <div id="generalLoginError" class="login-error-general"></div>
        <form id="loginForm" class="login-form">

            <label>Username</label>
            <input type="text" id="username" placeholder="Masukan Username">
            <p id="userError" class="error-msg"></p>

            <label>Password</label>
            <input type="password" id="password" placeholder="Masukan Password">
            <p id="passError" class="error-msg"></p>

            <button type="submit" class="btn-login" id="loginButton">Login</button>
        </form>

        <p class="forgot-pass">
            <a href="forgot-password.html">Lupa Password?</a>
        </p>
    </div>
</div>

<div class="popup-fixed popup-success" id="successLoginPopup">
    <h3>Login Berhasil!</h3>
    <p>Mengalihkan dalam 2 detik...</p>
</div>

<div class="popup-fixed popup-error" id="errorPopup">
    <h3>Koneksi Gagal</h3>
    <p id="errorPopupMessage">Pastikan server Anda berjalan.</p>
</div>


<script>
    // URL BACKEND LOKAL LARAVEL DEFAULT
    const API_LOGIN_URL = "http://127.0.0.1:8000/api/login"; 

    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginButton = document.getElementById("loginButton");

    const userError = document.getElementById("userError");
    const passError = document.getElementById("passError");
    const generalLoginError = document.getElementById("generalLoginError");
    const statusNotification = document.getElementById("statusNotification");

    const successLoginPopup = document.getElementById("successLoginPopup");
    const errorPopup = document.getElementById("errorPopup");
    const errorPopupMessage = document.getElementById("errorPopupMessage");

    // Helper untuk popup
    function showPopup(popupEl, message = '', isError = false) {
        if (isError) {
            errorPopupMessage.textContent = message;
            popupEl = errorPopup;
        } else if (message) {
            popupEl.querySelector('p').textContent = message;
        }

        popupEl.style.display = 'block';
        popupEl.style.animation = 'slideInFromRight 0.4s ease-out forwards';

        if (isError) {
            setTimeout(() => {
                popupEl.style.animation = 'none';
                popupEl.style.display = 'none';
            }, 4000);
        }
    }

    // Status URL Verifikasi Email
    function handleVerificationStatus() {
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('verified');
        let message = '';
        let bgColor = '';
        let color = '';

        if (status === 'true') {
            message = "ðŸŽ‰ Verifikasi berhasil! Silakan login.";
            bgColor = '#d4edda';
            color = '#155724';
        } else if (status === 'already') {
            message = "âœ… Akun Anda sudah terverifikasi. Silakan login.";
            bgColor = '#d4edda';
            color = '#155724';
        } else if (status === 'invalid_token') {
            message = "âŒ Tautan verifikasi tidak valid atau kedaluwarsa.";
            bgColor = '#f8d7da';
            color = '#721c24';
        }

        if (message) {
            statusNotification.textContent = message;
            statusNotification.style.backgroundColor = bgColor;
            statusNotification.style.color = color;
            statusNotification.style.display = 'block';
            history.replaceState(null, '', window.location.pathname);
        }
    }

    handleVerificationStatus();

    // FORM SUBMIT
    loginForm.addEventListener("submit", async function(e) {
        e.preventDefault();

        // Reset error
        generalLoginError.style.display = 'none';
        userError.textContent = "";
        passError.textContent = "";

        usernameInput.classList.remove("input-valid", "input-invalid");
        passwordInput.classList.remove("input-valid", "input-invalid");

        let valid = true;

        // Validasi username FE
        if (usernameInput.value.trim() === "") {
            valid = false;
            userError.textContent = "Username tidak boleh kosong";
            usernameInput.classList.add("input-invalid");
        }

        // Validasi password FE
        if (passwordInput.value.trim() === "") {
            valid = false;
            passError.textContent = "Password tidak boleh kosong";
            passwordInput.classList.add("input-invalid");
        }

        if (valid) {
            usernameInput.classList.add("input-valid");
            passwordInput.classList.add("input-valid");
        }

        if (!valid) return;

        const data = {
            username: usernameInput.value.trim(),
            password: passwordInput.value.trim()
        };

        loginButton.textContent = "Logging in...";
        loginButton.disabled = true;

        try {
            const response = await fetch(API_LOGIN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            loginButton.textContent = "Login";
            loginButton.disabled = false;

            // --- 200 OK ---
            if (response.ok) {

                if (result.token) localStorage.setItem('token', result.token);
                if (result.user_id) localStorage.setItem('user_id', result.user_id);

                showPopup(successLoginPopup, "Mengalihkan dalam 2 detik...");

                setTimeout(() => {
                    window.location.href = "beranda.html";
                }, 2000);
            }

            // --- 401 Wrong Credential ---
            else if (response.status === 401) {
                userError.textContent = result.message || "Username atau password salah.";
                usernameInput.classList.add("input-invalid");
                passwordInput.classList.add("input-invalid");
            }

            // --- 403 Belum Verifikasi ---
            else if (response.status === 403) {
                generalLoginError.textContent =
                    result.message || "Akun belum aktif. Mohon verifikasi email Anda.";
                generalLoginError.style.display = 'block';
                usernameInput.classList.add("input-invalid");
                passwordInput.classList.add("input-invalid");
            }

            // --- 422 Laravel Validation Error ---
            else if (response.status === 422) {
                if (result.errors) {

                    if (result.errors.username) {
                        userError.textContent = result.errors.username[0];
                        usernameInput.classList.add("input-invalid");
                    }

                    if (result.errors.password) {
                        passError.textContent = result.errors.password[0];
                        passwordInput.classList.add("input-invalid");
                    }

                } else {
                    generalLoginError.textContent =
                        result.message || "Input tidak valid.";
                    generalLoginError.style.display = 'block';
                }
            }

            // --- ERROR LAINNYA ---
            else {
                showPopup(
                    errorPopup,
                    result.message || `Terjadi kesalahan server (${response.status}).`,
                    true
                );
            }

        } catch (error) {
            loginButton.textContent = "Login";
            loginButton.disabled = false;
            console.error("Fetch Error:", error);
            showPopup(errorPopup, "Koneksi gagal. Pastikan server Laravel Anda berjalan.", true);
        }
    });
</script>


</body>
</html>