<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Advisor | Login</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }

        body, .login-page {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(
                rgba(0,0,0,0.55),
                rgba(0,0,0,0.55)
            ), url('login.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-card {
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255,255,255,0.1);
            width: 95%;
            max-width: 800px; 
            padding: 60px 80px;
            border-radius: 22px;
            box-shadow: 0 20px 45px rgba(0,0,0,0.55);
            color: white;
            position: relative;
        }

        .header-center {
            text-align: center;
            margin-bottom: 40px;
        }

        .brand {
            font-size: 42px;
            font-weight: 800;
            color: #28a745;
            margin: 0;
            white-space: nowrap;
            display: block;
        }

        .register-text {
            margin-top: 12px;
            font-size: 16px;
            color: #ccc;
        }

        .register-text a {
            color: #28a745;
            text-decoration: none;
            font-weight: 600;
        }

        .login-title {
            text-align: center;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 32px;
        }

        /* Error Messages */
        .error-msg {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 4px;
            height: 14px;
        }

        .general-error {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        #statusNotification {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        form {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 18px;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            color: #dcdcdc;
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            height: 50px;
            padding: 0 20px;
            font-size: 16px;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 10px;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }

        input.input-invalid { border-color: #ff6b6b; }
        input.input-valid { border-color: #28a745; }

        input:focus {
            border-color: #28a745;
            background: rgba(255,255,255,0.18);
        }

        .btn-login {
            height: 52px;
            font-size: 17px;
            font-weight: 800;
            background: #28a745;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .btn-login:disabled { opacity: 0.6; cursor: not-allowed; }

        .forgot-pass {
            text-align: center;
            margin-top: 30px;
            font-size: 15px;
        }

        .forgot-pass a {
            color: #28a745;
            font-weight: 700;
            text-decoration: none;
        }

        /* --- POPUP STYLES UPDATED --- */
        .popup-fixed {
            position: fixed;
            top: 20px;
            right: -400px;
            width: 250px; /* Ukuran lebih kecil */
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Popup Berhasil: BG Putih, Teks Hijau */
        .popup-success { 
            background: #ffffff; 
            border-left: 5px solid #28a745;
        }
        .popup-success h3 { 
            color: #28a745; 
            margin: 0; 
            font-size: 16px;
            font-weight: 800;
        }
        .popup-success p { 
            color: #555; 
            margin: 5px 0 0 0;
            font-size: 13px;
        }

        .popup-error { background: #dc3545; color: white; }

        @keyframes slideInFromRight {
            from { right: -400px; opacity: 0; }
            to { right: 20px; opacity: 1; }
        }

        @media (max-width: 768px) {
            .login-card { padding: 48px 30px; }
            .brand { font-size: 32px; }
        }
    </style>
</head>

<body>

<div class="login-page">
    <div class="login-card">
        
        <div id="statusNotification"></div>

        <div class="header-center">
            <h1 class="brand">Plant Advisor</h1>
            <p class="register-text">
                Don't Have an Account? <a href="register.html">Register</a>
            </p>
        </div>

        <h2 class="login-title">Login</h2>

        <div id="generalLoginError" class="general-error"></div>

        <form id="loginForm">
            <div class="field-group">
                <label for="username">Username</label>
                <input id="username" type="text" placeholder="Masukkan username">
                <div id="userError" class="error-msg"></div>
            </div>

            <div class="field-group">
                <label for="password">Password</label>
                <input id="password" type="password" placeholder="Masukkan password">
                <div id="passError" class="error-msg"></div>
            </div>

            <button type="submit" id="loginButton" class="btn-login">Login</button>
        </form>

        <p class="forgot-pass">
            <a href="forgot-password.html">Lupa Password?</a>
        </p>
    </div>
</div>

<div class="popup-fixed popup-success" id="successLoginPopup">
    <h3>Berhasil Login!</h3>
    <p>Mengalihkan halaman...</p>
</div>

<div class="popup-fixed popup-error" id="errorPopup">
    <h3>Terjadi Kesalahan</h3>
    <p id="errorPopupMessage">Pastikan server Anda berjalan.</p>
</div>

<script>
    const API_LOGIN_URL = "http://plantadvisor.cloud/api/login"; 

    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginButton = document.getElementById("loginButton");

    const userError = document.getElementById("userError");
    const passError = document.getElementById("passError");
    const generalLoginError = document.getElementById("generalLoginError");
    const statusNotification = document.getElementById("statusNotification");

    const successLoginPopup = document.getElementById("successLoginPopup");
    const errorPopup = document.getElementById("errorPopup");
    const errorPopupMessage = document.getElementById("errorPopupMessage");

    function showPopup(popupEl, message = '', isError = false) {
        if (isError) {
            errorPopupMessage.textContent = message;
            popupEl = errorPopup;
        } else if (message && !isError) {
            // Kita bisa update sub-text jika perlu
            const p = popupEl.querySelector('p');
            if(p) p.textContent = message;
        }

        popupEl.style.display = 'block';
        popupEl.style.animation = 'slideInFromRight 0.4s ease-out forwards';

        if (isError) {
            setTimeout(() => {
                popupEl.style.animation = 'none';
                popupEl.style.display = 'none';
            }, 4000);
        }
    }

    function handleVerificationStatus() {
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('verified');
        let message = '';
        let bgColor = '';
        let color = '';

        if (status === 'true') {
            message = "ðŸŽ‰ Verifikasi berhasil! Silakan login.";
            bgColor = '#d4edda'; color = '#155724';
        } else if (status === 'already') {
            message = "âœ… Akun Anda sudah terverifikasi. Silakan login.";
            bgColor = '#d4edda'; color = '#155724';
        } else if (status === 'invalid_token') {
            message = "âŒ Tautan verifikasi tidak valid atau kedaluwarsa.";
            bgColor = '#f8d7da'; color = '#721c24';
        }

        if (message) {
            statusNotification.textContent = message;
            statusNotification.style.backgroundColor = bgColor;
            statusNotification.style.color = color;
            statusNotification.style.display = 'block';
            history.replaceState(null, '', window.location.pathname);
        }
    }

    handleVerificationStatus();

    loginForm.addEventListener("submit", async function(e) {
        e.preventDefault();

        generalLoginError.style.display = 'none';
        userError.textContent = "";
        passError.textContent = "";
        usernameInput.classList.remove("input-valid", "input-invalid");
        passwordInput.classList.remove("input-valid", "input-invalid");

        let valid = true;
        if (usernameInput.value.trim() === "") {
            valid = false;
            userError.textContent = "Username tidak boleh kosong";
            usernameInput.classList.add("input-invalid");
        }
        if (passwordInput.value.trim() === "") {
            valid = false;
            passError.textContent = "Password tidak boleh kosong";
            passwordInput.classList.add("input-invalid");
        }

        if (!valid) return;

        loginButton.textContent = "Logging in...";
        loginButton.disabled = true;

        try {
            const response = await fetch(API_LOGIN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: usernameInput.value.trim(),
                    password: passwordInput.value.trim()
                })
            });

            const result = await response.json();
            loginButton.textContent = "Login";
            loginButton.disabled = false;

            if (response.ok) {
                if (result.token) localStorage.setItem('token', result.token);
                if (result.user_id) localStorage.setItem('user_id', result.user_id);
                
                const loggedInUsername = result.username || (result.user && result.user.username);
                localStorage.setItem('username', loggedInUsername || usernameInput.value.trim());

                showPopup(successLoginPopup, "Mengalihkan dalam 2 detik...");
                setTimeout(() => { window.location.href = "beranda.html"; }, 2000);
            } 
            else if (response.status === 401) {
                userError.textContent = result.message || "Username atau password salah.";
                usernameInput.classList.add("input-invalid");
                passwordInput.classList.add("input-invalid");
            } 
            else if (response.status === 403) {
                generalLoginError.textContent = result.message || "Akun belum aktif.";
                generalLoginError.style.display = 'block';
            } 
            else if (response.status === 422) {
                if (result.errors) {
                    if (result.errors.username) userError.textContent = result.errors.username[0];
                    if (result.errors.password) passError.textContent = result.errors.password[0];
                }
            } 
            else {
                showPopup(errorPopup, result.message || `Error ${response.status}`, true);
            }

        } catch (error) {
            loginButton.textContent = "Login";
            loginButton.disabled = false;
            showPopup(errorPopup, "Koneksi gagal. Periksa server Laravel Anda.", true);
        }
    });
</script>

</body>
</html>