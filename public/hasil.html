<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Hasil Rekomendasi - PlantAdvisor</title>
    <link rel="stylesheet" href="style.css" /> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        .container-detail {
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
        }
        .page-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--color-primary);
            margin-bottom: 20px;
        }
        .back-link {
            text-decoration: none;
            color: var(--color-primary);
            margin-right: 10px;
        }
        .content-box {
            background: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        #loading-state, #error-state {
            text-align: center;
            padding: 20px;
        }
        .recommendation-card {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .recommendation-card.recommended {
            border: 2px solid var(--color-success);
            background-color: #f0fff0;
        }
        .plant-header h4 {
            margin: 0;
            color: var(--color-primary);
            font-size: 18px;
            font-weight: 800;
        }
        .description-text {
            font-size: 14px;
            color: #555;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo">PlantAdvisor</div>
        <nav class="main-nav">
            <a href="beranda.html">Beranda</a>
        </nav>
        <div class="header-buttons" id="headerButtons"></div>
    </header>

    <main class="container-detail">
        <h2 class="page-title">
            <a href="beranda.html" class="back-link">&lt;</a> Hasil Rekomendasi Tanaman
        </h2>

        <div id="content-area">
            <div id="loading-state" class="content-box">
                <p>‚öôÔ∏è <b>Memproses data tanah...</b> Mohon tunggu sebentar.</p>
            </div>

            <div id="error-state" class="content-box" style="display:none; border-left: 5px solid var(--color-danger); padding: 15px;">
                <p>‚ùå Gagal memuat rekomendasi.</p>
            </div>

            <div id="result-container" class="content-box"></div>
        </div>

        <div class="action-buttons">
            <a href='beranda.html#AII' class="btn btn-primary btn-large">Coba Input Baru</a>
        </div>
    </main>

    <footer class="footer">
        ¬© 2025 PlantAdvisor. All rights reserved.
    </footer>

    <script>
        const API_BASE_URL = "https://plantadvisor.cloud/api";

        document.addEventListener('DOMContentLoaded', () => {
            fetchRecommendation();
            updateHeaderButtons();
        });

        function updateHeaderButtons() {
            const headerButtons = document.getElementById('headerButtons');
            const token = localStorage.getItem("token");

            if (!headerButtons) return;

            if (token) {
                headerButtons.innerHTML = `
                    <a href="#" class="btn btn-logout" onclick="handleLogout(event)">Logout</a>
                `;
            } else {
                headerButtons.innerHTML = `
                    <a href="login.html" class="btn btn-primary">Login</a>
                `;
            }
        }

        function handleLogout(e) {
            e.preventDefault();
            localStorage.removeItem("token");
            localStorage.removeItem("input_id");
            localStorage.removeItem("user_id");
            window.location.href = "beranda.html";
        }

        async function fetchRecommendation() {
            const inputId = localStorage.getItem('last_input_id'); // FIX üî•
            const resultContainer = document.getElementById('result-container');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');

            console.log("Input ID ditemukan:", inputId); // Debug

            if (!inputId) {
                loadingState.innerHTML = "‚ùå Data input tidak ditemukan. Silakan <a href='beranda.html' style='color:var(--color-primary);'>isi data tanah</a> terlebih dahulu.";
                return;
            }

            const recommendationUrl = `${API_BASE_URL}/recommendation/${inputId}`;
            const token = localStorage.getItem("token");

            const headers = {};
            if (token) headers["Authorization"] = `Bearer ${token}`;

            loadingState.style.display = 'block';
            resultContainer.innerHTML = '';
            errorState.style.display = 'none';

            try {
                const response = await fetch(recommendationUrl, { method: 'GET', headers });
                const result = await response.json();

                loadingState.style.display = 'none';

                if (response.ok) {
                    displayRecommendation(result.recommendation_data);
                    localStorage.removeItem('input_id'); // FIX üî•
                } else {
                    errorState.textContent = `‚úó Error API: ${result.message || 'Gagal memproses rekomendasi'}.`;
                    errorState.style.display = 'block';
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                loadingState.style.display = 'none';
                errorState.textContent = "Terjadi masalah koneksi ke server rekomendasi. Cek konsol.";
                errorState.style.display = 'block';
            }
        }

function displayRecommendation(data) {
    const container = document.getElementById('result-container');

    if (!data || data.length === 0) {
        container.innerHTML = "<h3>Tidak ada rekomendasi</h3><p>Tidak ditemukan tanaman yang cocok.</p>";
        return;
    }

    let html = `<h3>‚úÖ ${data.length} Rekomendasi Tanaman:</h3>`;

    data.forEach((plant, index) => {
        // Gunakan care_instructions dari controller (hardcode) sebagai alasan
        const cardClass = 'recommendation-card'; // FE tidak perlu highlight probabilitas

        html += `
            <div class="${cardClass}">
                <div class="plant-header">
                    <h4>${index + 1}. ${plant.nama_tanaman}</h4>
                </div>
                <p class="description-text">
                    <b>Alasan:</b> ${plant.care_instructions}
                </p>
                <a href="detail-tanaman.html?name=${plant.nama_tanaman}" class="btn btn-outline">Lihat Detail</a>
            </div>
        `;
    });

    container.innerHTML = html;
}

    </script>

</body>
</html>
